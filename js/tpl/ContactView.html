<style>
  .biomio_captcha {
    width: 290px;
    height: 87px;
    border: 1px solid #CCC;
    border-radius: 3px;
    padding: 3px;

    font-family: Arial,sans-serif;
    font-size: 14px;
    line-height: normal;
    color: #333;
    box-sizing: border-box;
  }
  .biomio_captcha .left {
    width: 208px;
    height: 70px;
    padding: 5px 5px;
    display: inline-block;
    box-sizing: inherit;
  }
      .biomio_captcha .image {
        width: 206px;
        height: 46px;
        border: 1px solid #CCC;
        padding: 2px;
        border-radius: 3px;
        box-sizing: inherit;
      }
      .biomio_captcha .input {
        margin-top: 3px;
        width: 174px;
        height: 25px;
        display: inline-block;
        box-sizing: inherit;
      }
          .biomio_captcha .input_captcha {
            width: 175px;
            height: 25px;
            box-sizing: inherit;
            border: 1px solid #CCC;

            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
          }
      .biomio_captcha .captcha_refresh {
        margin-top: 3px;
        width: 20px;
        height: 25px;
        padding-left: 6px;

        display: inline-block;
        cursor: pointer;
        box-sizing: inherit;
        color: inherit;
        font: inherit;
        margin: 0px;
      }
      .biomio_captcha .captcha_refresh:hover {
        font-weight: bold;
      }
  .biomio_captcha .right {
    width: 60px;
    height: 60px;
    padding: 5px;
    display: inline-block;
    box-sizing: inherit;
    vertical-align: top;
    text-align: left;
    float: none;
  }
      .biomio_captcha .bio_captcha {
        width: 60px;
        height: 60px;
        cursor: pointer;

        vertical-align: top;
        border: 0px none;
        box-sizing: inherit;
      }
      .biomio_captcha .bio_captcha:hover {
        width: 61px;
        height: 61px;
        -moz-box-shadow:    3px 3px 5px 3px #ccc;
        -webkit-box-shadow: 3px 3px 5px 3px #ccc;
        box-shadow:         3px 3px 5px 3px #ccc;
      }
      .captcha_success {
        position: absolute;
        width: 290px;
    	height: 87px;
    	color: #77B55A;
    	font-size: 40px;
    	font-weight: bold;
    	text-align: center;
    	margin-top: -5px;
    	margin-left: -5px;
    	border-radius: 3px;
    	padding-top: 15px;
    	text-shadow: 0 0 20px #77B55A;
    	background: white;

	    z-index:1001;
	    -moz-opacity: 0.9;
	    opacity:.90;
	    filter: alpha(opacity=90);

    	webkit-box-shadow: inset 0px 0px 5px 0px rgba(68,148,15,1);
        -moz-box-shadow: inset 0px 0px 5px 0px rgba(68,148,15,1);
        box-shadow: inset 0px 0px 5px 0px rgba(68,148,15,1);

      }
</style>

<div class='row'>
	<div class='col-sm-8 col-sm-offset-2'>
		<div class="panel panel-primary">
			<div class="panel-heading"><h3>Contact us</h3></div>
			<div class="panel-body">

				<form class="form-horizontal">
				    <div class="col-sm-12">
				      <div class="form-group">
				        <label class="col-sm-3 control-label">Your Name</label>
				        <div class="col-sm-9">
				          <input type="text" class="form-control" id="contact_name" placeholder="Enter Name" required>
				        </div>
				      </div>
				      <div class="form-group">
				        <label class="col-sm-3 control-label">Your Email</label>
				        <div class="col-sm-9">
				          <input type="email" class="form-control" id="contact_email" placeholder="Enter Email" required  >
				        </div>
				      </div>
				      <div class="form-group">
				        <label class="col-sm-3 control-label">Message</label>
				        <div class="col-sm-9"
				>
				          <textarea id="contact_message" class="form-control" rows="5" required></textarea>
				        </div>
				      </div>
				      <div class="form-group captcha-form">
				        <label id="contact_captcha_question" class="col-sm-3 control-label"></label>
				        <div class="col-sm-9">
				          	<div class='biomio_captcha transparent'>
				          	  <div class='captcha_success hide'>Success</div>
							  <div class='left'>
							    <div class='image'></div>
							    <div class='input'>
							      <input class="input_captcha" placeholder="Enter the text" type="text">
							    </div>
							    <div class='captcha_refresh'>
							      &#8635;
							    </div>
							  </div>
							  <div class='right'>
							    <img class='bio_captcha' src="http://biom.io/img/smallLogo.png">
							  </div>
							</div>
				        </div>
				      </div>
				      <div class="form-group">
				        <label class="col-sm-3 control-label"></label>
				        <div class="col-sm-9">
				          <button type="submit" id="contact_submit" class="col-sm-3 col-sm-offset-9 btn btn-success"><span class="glyphicon glyphicon-send"></span></button>
				        </div>
				      </div>
				    </div>
				  </form>

			</div>
		</div>
	</div>
</div>

<!--<div class='row'>
	<div class='col-md-6'>
		<div class="panel panel-info">
			<div class="panel-heading"><h3>Follow us on Social Networks</h3></div>
			<div class="panel-body">
                <p>
                	<a href='https://www.facebook.com/biomio123'> <img src='img/facebook.png' alt=''/></a>
                	<a href='https://www.facebook.com/biomio123'> Facebook </a>

                </p>
                <p>
                	<a href='https://twitter.com/_biomio_'> <img src='img/twitter.png' alt=''/></a>
                	<a href='https://twitter.com/_biomio_'> Twitter </a>
                </p>
                <p>
                	<a href='www.twitter.com/biomio' onclick="return false"> <img src='img/google.png' disabled="true" alt=''/></a>
                	<a href='www.twitter.com/biomio' onclick="return false"> Google </a>
                </p>
		  	</div>
		</div>
	</div>

	<div class='col-md-6'>
		<div class="panel panel-success">
			<div class="panel-heading"><h3>Contact Info</h3></div>
			<div class="panel-body">
				<address>
					<strong>BIOMIO, Inc.</strong><br>
					  742 Evergreen Terrace,<br>
					  Springfield, OR 98128<br>
				  	<abbr title="Phone">P:</abbr> (123) 456-7890<br>
				  	<a href="mailto:#">homer.simpson@biomio.com</a>
				</address>
			</div>
		</div>
	</div>
</div>
-->


<script>
 
  $(document).ready(function() {
    captcha_get_image();
  });

  $(document).on('click touchend', ".captcha_refresh", function () {
    captcha_get_image();
  });

  $(document).on('click touchend', "#contact_submit", function () {
   
    var user_answer = $(".input_captcha").val();
    
    $.ajax({
      url: 'php/captcha.php',
      method: 'POST',
      data: {cmd: 'check_code', user_answer: user_answer},
      async: false,
      success: function(data) {
      	if (data == 0) captcha_fail();
        else if (data == 1) captcha_success();
        else if (data == 2) captcha_expired();
      }
    });

  });

  function captcha_get_image() {
    $('.captcha_success').addClass('hide');
    $.ajax({
      url: 'php/captcha.php',
      method: 'POST',
      data: {cmd: 'create_image'},
      async: false,
      success: function(data) {
        var img = new Image();
        img.onload = function () {
            context.drawImage(this, 0, 0, canvas.width, canvas.height);
        }
        img.src = "data:image/png;base64," + data;
        $(".image").html(img);
        $(".input_captcha").val('');
        $(".input_captcha").prop('disabled', false);
      }
    });
  }

  function captcha_bio_success() {
  	captcha_stopSnapshots();
    $.ajax({
      url: 'php/captcha.php',
      method: 'POST',
      data: {cmd: 'bio_success'},
      async: false,
      success: function(data) {
        $('.captcha_success').removeClass('hide');
        $(".input_captcha").prop('disabled', true);
      }
    });
  }

  function captcha_success() {
    var name = $("#contact_name").val();
	var email = $("#contact_email").val();
	var message = $("#contact_message").val();
	var captcha = $("#contact_captcha_answer").val();

		$.ajax({
		    type: 'POST',
		    url: 'php/login.php',
		    data: {cmd: "contact", name: name, email: email, message: message},
		    success: function(data) {
		        alert("Thank you! Your message has been successfully sent.");
		        captcha_get_image();
		       	$("#contact_name").val('');
				$("#contact_email").val('');
				$("#contact_message").val('');
		    }
		});
  }

  function captcha_fail() {
    message('danger', 'Error: ', "captcha is incorrect");
    captcha_get_image();
  }

  function captcha_expired() {
  	message('danger', 'Error: ', "BIOMIO captcha has expired");
    captcha_get_image();
  }

</script>









<script>

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL;

    var localMediaStream = null;
    var captcha_snapshotTimer;
    var snapshotInProgress = false;
    var block = 0;

    //****************
    //**** COMMON *****
    //******************

    function captcha_snapshot() {
        if (localMediaStream && !snapshotInProgress && block == 0) {
            $('#scratchpad').attr('width', $('#capture-frame').prop('videoWidth'));
            $('#scratchpad').attr('height', $('#capture-frame').prop('videoHeight'));
            $('#scratchpad')[0].getContext('2d').drawImage($('#capture-frame')[0], 0, 0);
            snapshotInProgress = true;
            captcha_processDataURL($('#scratchpad')[0].toDataURL('image/jpeg'));
        }
    }

    function captcha_startSnapshots() {
        captcha_snapshotTimer = setInterval(captcha_snapshot, 1000);
        $('body').addClass('capturing');
    }

    function captcha_stopSnapshots() {
        block = 1;
        snapshotInProgress = true; 
        clearInterval(captcha_snapshotTimer);//for some reason this doesn't work, so I use var block to stop
        localMediaStream.stop();
        $('body').removeClass('capturing');
    }

    function captcha_continueSnapshots() {
        snapshotInProgress = false;
    }

    function captcha_cameraAvailable(stream) {
        if (window.URL) {
            $('#preview').attr('src', window.URL.createObjectURL(stream));
            $('#capture-frame').attr('src', window.URL.createObjectURL(stream));
        } else {
            $('#preview').prop('src', stream);
            $('#capture-frame').prop('src', stream);
        }
        $('body').removeClass('camerasetup');
        localMediaStream = stream;
    }

    function captcha_cameraFailed(e) {
        console.log('camera failed',e);
        $('body').removeClass('camerasetup');
        $('body').addClass('nocam');
        $('body').addClass('noimage');
    };

    function captcha_uploadSelected() {
        var files = $('#file-input').prop('files');
        if (files.length > 0) {
            var reader = new FileReader();
            reader.onload = function(event) {
                $('#image-preview').attr('src', event.target.result);
                $('body').removeClass('noimage');
                captcha_processDataURL(event.target.result);
            };
            reader.readAsDataURL(files[0]);
        }
    };

    function captcha_startCamera() {
        if (navigator.getUserMedia) {
            navigator.getUserMedia({video: true}, captcha_cameraAvailable, captcha_cameraFailed);
        } else {
            captcha_cameraFailed('No navigator.getUserMedia');
        }
    }

    function captcha_loadUser() {
        url = 'http://ec2-54-187-197-187.us-west-2.compute.amazonaws.com/api/users/' + 1;

        $.ajax({
            url: url,
        }).done(function(data) {
            captcha_startCamera();
            captcha_startSnapshots();
            $('.biomio_user_form').addClass('hide');
            $('.biomio_body').removeClass('hide');
            $('.biomio_overlay').removeClass('hide');

            biomioId = data.id
            $('body').addClass('user-loaded');
            captcha_continueSnapshots();
        }).fail(function(data) {
            $('.biomio-error').html("User is not found");
        });
    }

    //****************
    //**** VERIFY *****
    //******************
    var captcha_processDataURL = function(image) {
      $.ajax({
          type: "POST",
          url: 'http://ec2-54-187-197-187.us-west-2.compute.amazonaws.com/api/users/' + 1 + '/verify',
          contentType: 'application/octet-stream',
          data: image.split(',')[1]
      }).done(function(data) {
          console.log(data);
          var score = parseFloat(data);
          if (score >= 30) {
              captcha_bio_success();
              alert('Success');
              $('.white_content').addClass('hide');
              $('.black_overlay').addClass('hide');
          }
          captcha_continueSnapshots();
      }).fail(function(jqXHR, textStatus, errorThrown) {
          console.log(jqXHR, textStatus, errorThrown);
          captcha_continueSnapshots();
      });
    };

    $(document).on('click touchend', ".bio_captcha", function (event) {    
        event.preventDefault();
        captcha_render_form();
        $('#file-input').change(captcha_uploadSelected);
        $('body').addClass('camerasetup');
        block = 0;
     });

    $(document).on('click touchend', ".biomio_overlay, .close-box", function () {
        captcha_stopSnapshots(); 
        $('.biomio_body').addClass('hide');
        $('.biomio_overlay').addClass('hide');
    });

    function captcha_render_form() {
        $.ajax({
            url: "http://biom.io/tpl/forms/Captcha.html",
            type: 'GET',
            xhrFields: {
                withCredentials: false
            },
            headers: {
            },
            success: function(data) {
                $('.content-div').html(data);
                $('.white_content').removeClass('hide');
                $('.black_overlay').removeClass('hide');
                captcha_loadUser();
            }
        });
    }


</script>